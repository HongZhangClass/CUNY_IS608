<!--
File:        DaveLanger_D3_Viz.html
Author:      Dave Langer
Description: This file implements the IS608 Module 6 assignment for creating a D3
             visualization of the data I am using for my final project. See the "DataMunging"
             folder for more details on the processed data used in this visualization.
-->
<html>
    <head>
        <title>Best US Locations for Data Scientists</title>
        <link rel="stylesheet" href="bootstrap.min.css" />
        <script src="d3.v3.min.js" charset="utf-8"></script>
        <script src="d3.tip.js"></script>
    </head>
    <style>
        .d3-tip {
            line-height: 1.5;
            padding: 12px;
            background: rgba(241,238,246, 0.8);
            border-radius: 2px;
        }

    </style>
    <body>
        <div class="container">
            <div class="row">
                <div class="col-md-12">
                    <h1><p class="text-center">Best US Locations for Data Scientists</p></h1>
                    <h3><p class="text-center">Choropleth Map of <a href="http://www.bls.gov/oes/tables.htm">May 2014 OES Data</a> for Computer & Math Occupations</p></h3>
                    <p class="text-center">For <a href="http://jlaurito.github.io/CUNY_IS608/">CUNY IS608</a> | <a href="writeup.pdf">Writeup</a></p>
                </div>
            </div>
            <br><br><br>
            <div class="row">
                <div class="col-md-12 text-center">
                    <svg id="map"></svg>
                </div>
            </div>
            <script>
                // Set up map projection to match D3 viewport
                var w = 1000;
                var h = 600;
                var projection = d3.geo.albersUsa()
                                   .translate([w / 2, h / 2])
                                   .scale([w]);

                // Create the page's SVG element
                var svg = d3.select("#map")
                            .attr("width", w)
                            .attr("height", h);

                // Instantiate a D3 geo path object to draw the map
                var path = d3.geo.path()
                            .projection(projection);

                // Utility function to add commas to numeric values to increase readability
                function formatNumber (num) {
                    return num.toString().replace(/(\d)(?=(\d{3})+(?!\d))/g, "$1,")
                }

                // Instantiate a D3-tip tooltip object for States
                var stateTip = d3.tip()
                        .attr("class", "d3-tip")
                        .offset([-10, 0])
                        .html(function(d) {
                            return "<span style=\"color:black\">" +
                                     "<h4>" + d.properties.NAME + "</h4>" +
                                    "Total Employment:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;" + formatNumber(d.properties.TOT_EMP) + "<br>" +
                                    "Median Annual Salary: $" + formatNumber(d.properties.A_MEDIAN) + "<br>" +
                                    "Mean Annual Salary:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$" + formatNumber(d.properties.A_MEAN) + "<br>" +
                                    "</span>";
                        });
                svg.call(stateTip);

                // Instantiate a D3-tip tooltip object for Cities
                var cityTip = d3.tip()
                        .attr("class", "d3-tip")
                        .offset([-10, 0])
                        .html(function(d) {
                            console.log(d);

                            return "<span style=\"color:black\">" +
                                    "<h6>" + d.AREA_NAME + "</h6>" +
                                    "Total Employment:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;" + formatNumber(d.TOT_EMP) + "<br>" +
                                    "Median Annual Salary: $" + formatNumber(d.A_MEDIAN) + "<br>" +
                                    "Mean Annual Salary:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$" + formatNumber(d.A_MEAN) + "<br>" +
                                    "</span>";
                        });
                svg.call(cityTip);

                // Utility function to map scaled data values to color palette from
                // http://colorbrewer2.org/
                function getColor(value) {
                    if (value < -1.0) {
                        return "rgb(208,209,230)";
                    } else if (value < 0.0) {
                        return "rgb(166,189,219)";
                    } else if (value < 1.0) {
                        return "rgb(116,169,207)"
                    } else if (value < 2.0) {
                        return "rgb(43,140,190)";
                    } else {
                        return "rgb(4,90,141)";
                    }
                }

                // Load in munged state employment data
                d3.csv("CompMathState.csv", function(data) {
                    // Load in GeoJSON data for the map of the US 50 states
                    d3.json("us.json", function(json) {
                        for (var i = 0; i < data.length; i++) {
                            //Grab state name and the LOC_Q value for the current record
                            var dataState = data[i].STATE;

                            //Find the corresponding state inside the GeoJSON
                            for (var j = 0; j < json.features.length; j++) {
                                // See if there's a match between records
                                var jsonState = json.features[j].properties.NAME;
                                if (dataState == jsonState) {
                                    // Add the LOC_Q value to the JSON data for coloring
                                    json.features[j].properties.SCALED_TOT_EMP = parseFloat(data[i].SCALED_TOT_EMP);
                                    json.features[j].properties.SCALED_A_MEDIAN = parseFloat(data[i].SCALED_A_MEDIAN);
                                    json.features[j].properties.TOT_EMP = parseFloat(data[i].TOT_EMP);
                                    json.features[j].properties.JOBS_1000 = parseFloat(data[i].JOBS_1000);
                                    json.features[j].properties.A_MEDIAN = parseFloat(data[i].A_MEDIAN);
                                    json.features[j].properties.A_MEAN = parseFloat(data[i].A_MEAN);

                                    // Found the state
                                    break;
                                }
                            }
                        }

                        // Bind data and create one path per GeoJSON feature
                        svg.selectAll("path")
                           .data(json.features)
                           .enter()
                           .append("path")
                           .attr("d", path)
                           .style("fill", function(d) {
                                //Get data value
                                var colorValue = d.properties.SCALED_A_MEDIAN;

                                if (colorValue) {
                                    //If value exists…
                                    return getColor(colorValue);
                                } else {
                                    //If value is undefined…
                                    return "#ccc";
                                }
                           })
                            .on("mouseover", stateTip.show)
                            .on("mouseout", stateTip.hide);

                        // Load cities data for plotting as points on map
                        d3.csv("CompMathCity.csv", function(data) {

                            svg.selectAll("circle")
                                .data(data)
                                .enter()
                                .append("circle")
                                .attr("cx", function(d) {
                                        return projection([d.LONG, d.LAT])[0];
                                    })
                                .attr("cy", function(d) {
                                        return projection([d.LONG, d.LAT])[1];
                                    })
                                .attr("r", function(d) {
                                        return Math.sqrt(parseInt(d.A_MEDIAN) * 0.0004);
                                    })
                                .style("fill", "yellow")
                                .style("opacity", 0.75)
                                .on("mouseover", cityTip.show)
                                .on("mouseout", cityTip.hide);
                        });
                    });
                });
            </script>
        </div>
    </body>
</html>