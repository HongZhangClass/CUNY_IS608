<!--Brian Chu, IS608 Final Project (Draft), May 15, 2014-->
<!DOCTYPE html>

<html>
    <head>
        <meta charset="utf-8">
        <script src="http://d3js.org/d3.v3.min.js"></script>
        <script src="http://d3js.org/topojson.v1.min.js"></script>
        <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
        <script src="//ajax.googleapis.com/ajax/libs/jqueryui/1.10.4/jquery-ui.min.js"></script>
        <script src="d3.tip.v0.6.3.js"></script>
        <script src="colorbrewer.js"></script>
        <link rel="stylesheet" href="//code.jquery.com/ui/1.10.4/themes/smoothness/jquery-ui.css">
        <link rel="stylesheet" type="text/css" href="FSAcrackcost.css">
        <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-51345217-1', 'jlaurito.github.io');
  ga('send', 'pageview');

</script>

        <style>

        </style>
		<title> FSA Cost Impact Map </title>
    </head>
    
    <body> 
    
<!--    Preamble-->
    <div id="intro", class="intro-text">
        <h1>Potential Savings From Applying The Crack Cocaine Fair Sentencing Act </h1>  
        <p>by Brian Chu</p>      
        <br>
        <p>This project was completed as part of CUNY IS608's curriculum. To see other projects, please <a href="http://jlaurito.github.io/CUNY_IS608/">click here for the homepage</a>.</p>
        <br>
        <p>
        Signed into Congress on August 3, 2010, the Fair Sentencing Act (FSA) intended to reduce the sentencing disparities between crack and powder cocaine offenders. Previously, a person found with 5 grams of crack cocaine would be subject to a mandatory five-year minimum sentence whereas a powder cocaine holder required 500 grams to receive the same penalty. Critics of this harsh imbalance also pointed to racial biases as the vast majority 
of crack cocaine users in the United States are African-Americans (83% in 2013<sup class="footnote-text">1</sup>). The FSA reduced the 100:1 ratio to 18:1 and eliminated the mandatory minimum sentence for first-time possession of crack cocaine. <br><br>
        
        Retroactive application of the FSA was voted into the guideline changes effective November 1, 2011. This amendment allows for eligible offenders currently imprisoned to seek a sentence reduction based on the new FSA regulations.<sup class="footnote-text">2</sup> Not all defendants, however, are eligible for FSA retroactivity and none are automatically applied without a judge's hearing. Nevertheless, there remains a backlog of convicted crack cocaine offenders still serving sentences under the old structure, leading to unjustified imprisonments and a burden on the United States prison system.                              
        </p>
        <br>
        <h2> Mapping the Prison Cost Impact of Retroactive Application </h2>
        <p>  
        The United States prison population is approximately 2.3 million, nearly a quarter of the world's 10 million overall total.<sup class="footnote-text">3</sup> Moreover, incarceration rates in the United States have risen over 700% since the 1970s and exact an extremely large financial burden on taxpayers. The Vera Institute of Justice reports that in 2011, the taxpayer burden was $39 billion and exceeded combined state correctional budgets by 14%.<sup class="footnote-text">4</sup> The mean annual taxpayer cost per inmate was calculated around $30,000, ranging from $14,000 in Kentucky to $60,000 in New York.<br><br>
        
        Combining these estimated rates with the thousands of crack cocaine offenders serving sentences, the annual incarceration cost is considerable. Retroactive application of the FSA could, therefore, have a significant impact on prison cost savings and particularly for taxpayers. Using preliminary data compiled by the United States Sentencing Commission (USSC), over 6,000 offenders (through 2013) have been granted retroactive sentence reductions at an average of 25 months reduction per case.<sup class="footnote-text">5</sup> Based on this amount, over $450 million of taxpayer savings may have already been realized as a result of FSA retroactivity. <br><br>
        
        The following map provides state-specific details on retroactive FSA applications granted and denied, average inmate costs and sentence reductions, and projected prison cost savings based on the Vera Institute and USSC reports. The data can be filtered by state based on the proportion of FSA applications denied. The map also allows for a sensitivity analysis to estimate potential new savings should some increased percentage of those currently denied be granted retroactive FSA application at the average state reduction rate.               
        </p>
    </div>
        
    <hr width="1200", align="left">
    
<!--    Radio button filter-->
    <div id="mapfilter" class="radio-filter">
        <br><br>
        Filter by percent of offenders denied retroactive sentence reduction:
        <div id="mapfilter" class="radio-buttons">
        <form>
            <input type="radio" id="filter1" name="filter" checked="checked" value=1> All states &nbsp&nbsp
            <input type="radio" id="filter2" name="filter" value=0.5> States over 25% denied &nbsp&nbsp
            <input type="radio" id="filter3" name="filter" value=0.75> States over 50% denied &nbsp&nbsp
            <input type="radio" id="filter4" name="filter" value=0.75>States over <input type="text" id="filtercustom" name="filter" style="width:20px"> % denied 
        </form>
        </div>
    </div>
    <br>
    
<!--    Sensitivity analysis slider-->
    <div id="slider-container", class="slider-box"> 
        <div id="slider-control", class="slider-text">  
            <p> Increase in sentence reduction grants<sup class="footnote-text">6</sup> [+5% steps]:
                <input type="text", id="amount", class="sens-amount", readonly="readonly"></p>
        </div>    
       
        <div id="slider" class="slider-tool"></div>
        <div id="scale" class="slider-scale">
        <p style="float:left">0%  <p style="float:right">100% </p></div>
               
    </div>
 
<!-- Map and Estimates-->
    <table>
        <tr>
            <td>
                <div id="map", class="map-main"></div>
            </td>
        
            <div class="estimate-group">
            <td class="estimate-group">
    
                <p> Estimated Total Savings<br>
                    <input type="text", id="SaveTotal", class="totals", readonly="readonly"></p>

                </p>
                
                <hr width="350", align="left">
                
                <p> Total Granted Reductions<sup class="footnote-text">7</sup><br>
                    <input type="text", id="Granted", class="totals", readonly="readonly"></p>
                
                
                <p> Total Denied Reductions<sup class="footnote-text">8</sup><br>
                    <input type="text", id="Denied", class="totals", readonly="readonly"></p>
                
                
                <hr width="350", align="left">
    
                <p> Average Annual Cost per Inmate<sup class="footnote-text">9</sup><br>
                    <input type="text", id="AnnCost", class="totals", readonly="readonly"></p>
                
                <p> Average Sentence Reduction<br>
                    <input type="text", id="AvgReduction", class="totals", readonly="readonly"></p>

                <hr width="350", align="left">
                
                <p><i>Sensitivity Analysis<sup class="footnote-text">10</sup><br>
					<input type="text", id="SensPerc", class="totals sens", readonly="readonly"></p>
					
                <p> Additional Granted Reductions<br>     
                    <input type="text", id="GrantNew", class="totals sens", readonly="readonly"></p>

                <p> Estimated Additional Savings<br>     
                    <input type="text", id="SaveNew", class="totals sens", readonly="readonly"></i></p>       
            </td>
            </div>
        </tr>
    </table>
    
    <hr width="1200", align="left">
	  
<!--    Footnotes-->
    <div id="footnotes", class="footnote-text">
        <h3> Sources and Notes </h3>
        
        <p> (1) U.S. Sentencing Commission: 2013 Datafile, <a href="http://bit.ly/1iMVTx8">USSCFY13 </a><br>
            (2) U.S. Sentencing Commission: <a href="http://bit.ly/1lAcn01">Most Frequently Asked Questions The 2011 Retroactive Crack Cocaine Guideline Amendment </a><br>
            (3) Bureau of Justice Statistics: <a href="http://www.bjs.gov/index.cfm?ty=pbdetail&iid=4842">Prisoners in 2012: Trends in Admissions and Releases 1991-2012</a><br>
            (4) Vera Institute of Justice: <a href="http://bit.ly/SZvCHi"> The Price of Prisons (July 2012)</a> <br> 
            (5) U.S. Sentencing Commission, <a href="http://bit.ly/SQTgFN"> Preliminary Crack Retroactivity Data Report Fair Sentencing Act (January 2014) </a><br>
            (6) Some offenders may be ineligible for a reduced sentence or be bound by minimum sentence regulations. 100% retroactivity, therefore, is likely unreasonable. Also see footnote 2 above. <br>
			(7) Data through 2013. 7,496 offenders were granted reduction but 824 cases could not determine imprisonment time, 36 could not be matched, and 182 in Guam, Puerto Rico, Northern Mariana Islands, and the Virgin Islands were not included here. <br>
			(8) Data through 2013. Some districts may not have reported all denials of motions seeking application of the retroactive crack cocaine amendment. Also, some denied contested motions have not yet been decided by the court.<br> 
			(9) Annual inmate cost estimates were not calculated for Alaska, Hawaii, Massachusetts, Mississippi, New Mexico, Oregon, South Carolina, South Dakota, Tennessee, Wyoming, and the District of Columbia. For these states, the mean amount of $30,096 from <br>	&nbsp&nbsp&nbsp&nbsp the remaining states was used for this analysis.<br>
			(10) The sensitivity analysis done here is solely on the proportion granted or denied retroactive FSA. Additional sensitivity analyses on the average inmate cost and length of sentence reduction would be reasonable complements to this piece.<br>
        </p> 
	
    </div>

<!--    being JS/d3  -->
    <script>

        //global variables
        var csv;
        var csv_nest;
        var state_nest;
        var state_filter;
        var perc = 0;
        
        
        var denyNew;
        var grantNew;
        var saveNew;
        var saveNewTotal;

        var width = 800;
        var height = 550;

        var thresh = 0;
        
        var color_breaks = [5000000, 15000000, 25000000, 50000000]
        var color_break_edges = [0, 5000000, 15000000, 25000000, 50000000]
        var legend_key = ["< $5m", "$5-15m", "$15-25m", "$25-50m", "> $50m"]  
        
        var scale_thresh = d3.scale.threshold()
            .domain(color_breaks)
            .range(colorbrewer.Greens[5]);
                    
        var projection = d3.geo.albersUsa()
            .scale(1000)
            .translate([width / 2, height / 2]);

        var path = d3.geo.path()
            .projection(projection);

        var svg = d3.select('#map').append("svg")
            .attr("width", width)
            .attr("height", height);
            
        var number = d3.format(",");
        var dollar = d3.format("$0,000");
       
		var west = d3.set(["CA", "OR", "WA", "ID", "NV", "UT", "AZ", "AK", "MT", "WY", "CO", "NM", "HI"]);
		
        var tip = d3.tip()
            .attr('class', 'd3-tip')
            .direction(function(d) {
						if (west.has(d.properties.state_abbr)){return "e"}
						else {return "w"}; })						
			.offset([-10, 0])
            .html(function(d) {
				return "<strong><span style='color:yellow; font-size:16px'>" +d.properties.state + "</strong></span><br>" +
					"<strong>Estimated Current Savings:</strong> <span style='color:yellow'>" +dollar(d3.round(+d.properties.saveTotalOrig), -2) + "</span><br><br>" +               
					"<strong>Current Number Granted Reduction:</strong> <span style='color:yellow'>"+number(d.properties.NgrantReduce) + " (" +d3.round((d.properties.percGrant *100),0) + "%"+") </span><br>" +                                      
					"<strong>Current Number Denied Reduction:</strong> <span style='color:yellow'>"+number(d.properties.NdenyAll) + " (" + d3.round((d.properties.percDeny * 100),0) + "%" +") </span><br><br>" +
					"<strong>Average Annual Cost per Inmate:</strong> <span style='color:yellow'>" +dollar(d.properties.avgAnnCost) + "</span><br>" +
					"<strong>Average Sentence Reduction:</strong> <span style='color:yellow'>"+d3.round(d.properties.avgMonthReduce,0) + " months" + "</span><br><br>" +                                        	
					"<strong>Increase in Number Granted Reduction:</strong> <span style='color:yellow'>"+d3.round(perc*100,0) + "%" + "</span><br>" +
					"<strong>New Number Granted Reduction:</strong> <span style='color:yellow'>"+number(d3.sum([d.properties.NgrantReduce, d3.round((+d.properties.NdenyAll * perc),0)])) + " (+" +number(d3.round              ((+d.properties.NdenyAll * perc),0)) + ") </span><br>" +
					"<strong>Estimated New Savings:</strong> <span style='color:yellow'>" +dollar(d3.round(d3.sum([d.properties.saveTotalOrig, (d.properties.NdenyAll * perc * d.properties.savePerInmate)]),-2)) + " (+" +dollar(d3.round((d.properties.NdenyAll * perc * d.properties.savePerInmate),-2)) + ")"; }) 


            // Load data: **Data acquired using local json (map) and csv (data) files**
		    d3.json("US_states_topo.json", function(error, json) {

                d3.csv("FSAcrackcost.csv", function(error, csv_data) {        
                    
                    csv = csv_data;
				
				    state_data = topojson.feature(json, json.objects.states).features;
				    state_nest = state_data;
			    			
			    		// make flat CSV into a nested (associative) array with state as key	
                    csv_nest = d3.nest()
                        .key(function(d) { return d.state; })
                        .entries(csv);

                    // join state data with csv data
                    state_nest.forEach(function(e, j) {
			            csv_nest.forEach(function(d, i) {
                        
                            if (e.properties.name === d.key) {
                                e.properties.state = d.values[0].state;
                                e.properties.state_abbr = d.values[0].state_abbr;
                                e.properties.avgMonthReduce = d.values[0].avgMonthReduce;
                                e.properties.avgPercReduce = d.values[0].avgPercReduce;
                                e.properties.avgAnnCost = d.values[0].avgAnnCost;
                                e.properties.savePerInmate = d.values[0].savePerInmate;
                                e.properties.saveTotalOrig = d.values[0].saveTotalOrig;
                                e.properties.NgrantReduce = d.values[0].NgrantReduce;
                                e.properties.NgrantAll = d.values[0].NgrantAll;
                                e.properties.NdenyAll = d.values[0].NdenyAll;
                                e.properties.percGrant = d.values[0].percGrant;                            
                                e.properties.percDeny = d.values[0].percDeny;
                            }
                        })
                    })                   

                    // default select option 1 (all states filter)
                    document.getElementById('filter1').click();                                                            
                })
            })
            
             
            // update estimates on side of map      
            function updateTotal(state_filter) {
                console.log(state_filter);
                grantOrig = d3.sum(state_filter, function(d) { return d.properties.NgrantReduce; }); 
                grantNew =  d3.sum(state_filter, function(d) { return d.properties.NdenyAll * perc; });            
                granted = grantOrig + grantNew;
                grantNew = number(d3.round(grantNew));
                granted = number(d3.round(granted, 0));
                
                denied = d3.sum(state_filter, function(d) { return d.properties.NdenyAll * (1-perc); });
                denied = number(d3.round(denied, 0));
                
                annCost = d3.median(state_filter, function(d) { return +d.properties.avgAnnCost; });
                annCost = dollar(d3.round(annCost,-2));
                
                avgRed = d3.mean(state_filter, function(d) { return +d.properties.avgMonthReduce; });
                avgRed = d3.round(avgRed, 0);
            
                saveNew = d3.sum(state_filter, function(d) { return d.properties.NdenyAll * perc * d.properties.savePerInmate; });                                
                saveOrig = d3.sum(state_filter, function(d) { return d.properties.saveTotalOrig; });
                saveTotal = saveOrig + saveNew;
                
                saveNew = dollar(d3.round(saveNew,-2));
                saveTotal = dollar(d3.round(saveTotal,-2));
                            
                function ready() {
                    $("#SaveTotal").val(saveTotal);
                    $("#Granted").val(granted);
                    $("#Denied").val(denied);
                    $("#AnnCost").val(annCost);
                    $("#AvgReduction").val(avgRed +" months");
				    $("#SensPerc" ).val("(+" + d3.round(perc*100,0) + "% reduction of denied offenders)" )
                    $("#GrantNew").val("+" + grantNew);
                    $("#SaveNew").val("+" + saveNew);
                }
                ready();   
            }
            
            
            // draw updated map based on filter or slider
            function updateMap(deny_threshold) {

                function ready(deny_threshold) {
                
                    console.log(state_nest);
                    state_filter = state_nest.filter(function(d) { return d.properties.percDeny >= deny_threshold; });
                    console.log(state_filter);
                    
                    // clear existing data from svg
                    svg.selectAll(".state-label").remove();
                    svg.selectAll("g").remove();
                    
                    // draw basemap 
                    svg.append("g")
                        .attr("class", "states")
                        .selectAll("path")
                        .data(state_nest)
                        .enter()                 
                        .append("svg:path");                                   
                    
                    // fill by threshold scale
                    svg.selectAll("path")
                        .data(state_filter)
                        .attr("d", path)              
                        .attr("fill", function(d) { return scale_thresh(+d.properties.saveTotalOrig + (d.properties.NdenyAll * perc * d.properties.savePerInmate)); })
                        .on('mouseover', tip.show)
                        .on('mouseout', tip.hide);

                    svg.call(tip);
                     
                    // add state abbreviation labels 
           			svg.selectAll(".state-label")
			            .data(state_filter)
			            .enter().append("text")
			            .attr("class", function(d) { return "state-label " + d.Id; })
			            .attr("transform", function(d) { return "translate(" + path.centroid(d) + ")"; })
			            .attr("dy", ".35em")
			            .text(function(d) { return d.properties.state_abbr; });  
                    
                    // append legend                       
                    var legend = svg.selectAll("g.legend")
                        .data(color_break_edges)
                        .enter().append("g")
                        .attr("class", "legend");

                    var ls_w = 20, ls_h = 20;

                    legend.append("rect")
                        .attr("x", .88*width)
                        .attr("y", function(d, i){ return height - (i*ls_h) - 2*ls_h;})
                        .attr("width", ls_w)
                        .attr("height", ls_h)
                        .style("fill", function(d, i) { return scale_thresh(d); })
                        .style("opacity", 0.8);
                        
                    legend.append("text")
                        .attr("x", .88*width + 30)
                        .attr("y", function(d, i){ return height - (i*ls_h) - ls_h - 4;})
                        .text(function(d, i){ return legend_key[i]; });
                                              
                    updateTotal(state_filter);                   
                }
               
                ready(deny_threshold);
            }
            
            
            // slider tool
            $(function() {
                $( "#slider" ).slider({
                    value: 0,
                    min: 0,
                    max: 100,
                    step: 5,
                    slide: function( event, ui ) {                    
                    perc = ui.value / 100
                        $( "#amount" ).val( "+" + ui.value +"%" ),                   
                        updateMap(thresh);
                    }               
                });
            
                $( "#amount" ).val( "+" + $( "#slider" ).slider( "value" ) +"%" )

            });


            // radio filter options
            $('#filter1').click(function (e) {
                console.log("hi");
                thresh = 0;
                updateMap(thresh);
            });

            $('#filter2').click(function (e) {
                console.log("hi2");
                thresh = 0.25;
                updateMap(thresh);
            });

            $('#filter3').click(function (e) {
                thresh = 0.5;
                updateMap(thresh);
            });
            
             $('#filter4').click(function (e) {
                thresh = ($('#filtercustom').val()) / 100;
                updateMap(thresh);
            });

        </script>       
    </body>
</html>
